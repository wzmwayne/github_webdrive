name: Update index.html

on:
  push:
    branches: [ main, master ]
    paths:
      - 'files/**'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-files:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Generate index.html
        run: |
          # ç”Ÿæˆ HTML å¤´éƒ¨
          cat > index.html << 'HTMLEOF'
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub äº‘ç›˜</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; border-radius: 8px; padding: 20px; }
        h1 { color: #333; margin-bottom: 20px; }
        .file-list { }
        .file-item { display: flex; align-items: center; padding: 12px; border-bottom: 1px solid #eee; }
        .file-icon { font-size: 24px; margin-right: 12px; }
        .file-name { flex: 1; }
        .file-size { color: #888; font-size: 0.9em; }
        .btn { padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; color: white; font-size: 0.9em; text-decoration: none; }
        .btn-download { background: #1976d2; }
        .empty { text-align: center; color: #888; padding: 40px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>â˜ï¸ GitHub äº‘ç›˜</h1>
        <div class="file-list">
HTMLEOF
          
          # éå† files ç›®å½•ç”Ÿæˆæ–‡ä»¶åˆ—è¡¨
          if [ -d "files" ]; then
            # æ·»åŠ ç›®å½•
            find files -type d | sort | while read -r dirpath; do
              dirname=$(basename "$dirpath")
              if [ "$dirpath" != "files" ]; then
                echo "            <div class=\"file-item\">" >> index.html
                echo "                <span class=\"file-icon\">ğŸ“</span>" >> index.html
                echo "                <span class=\"file-name\">$dirname/</span>" >> index.html
                echo "            </div>" >> index.html
              fi
            done
            
            # æ·»åŠ æ–‡ä»¶
            find files -type f | sort | while read -r filepath; do
              filename=$(basename "$filepath")
              relpath=$(echo "$filepath" | sed 's|^files/||')
              size=$(stat -c%s "$filepath" 2>/dev/null || echo "0")
              
              # æ ¼å¼åŒ–å¤§å°
              if [ "$size" -lt 1024 ]; then
                size_display="${size} B"
              elif [ "$size" -lt 1048576 ]; then
                size_display="$((size / 1024)).$((size % 1024 * 10 / 1024)) KB"
              else
                size_display="$((size / 1048576)).$((size % 1048576 * 10 / 1048576)) MB"
              fi
              
              download_url="https://raw.githubusercontent.com/wzmwayne/github_webdrive/main/files/$relpath"
              
              echo "            <div class=\"file-item\">" >> index.html
              echo "                <span class=\"file-icon\">ğŸ“„</span>" >> index.html
              echo "                <span class=\"file-name\">$filename</span>" >> index.html
              echo "                <span class=\"file-size\">$size_display</span>" >> index.html
              echo "                <a href=\"$download_url\" class=\"btn btn-download\" target=\"_blank\">ä¸‹è½½</a>" >> index.html
              echo "            </div>" >> index.html
            done
          else
            echo '            <div class="empty">ğŸ“­ æš‚æ— æ–‡ä»¶</div>' >> index.html
          fi
          
          # ç”Ÿæˆ HTML å°¾éƒ¨
          cat >> index.html << 'HTMLEOF'
        </div>
        <div style="margin-top: 30px; color: #888; font-size: 0.9em; text-align: center;">
            Powered by GitHub | é™æ€ç½‘é¡µ
        </div>
    </div>
</body>
</html>
HTMLEOF
          
          echo "index.html å·²ç”Ÿæˆ"
      
      - name: Commit and push changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          if git diff --quiet && git diff --staged --quiet; then
            echo "æ²¡æœ‰æ›´æ”¹ï¼Œæ— éœ€æäº¤"
          else
            git add index.html
            git commit -m "chore: è‡ªåŠ¨æ›´æ–° index.html"
            git push
          fi
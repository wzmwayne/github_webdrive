name: Update files.inf

on:
  push:
    branches: [ main, master ]
    paths:
      - 'files/**'
  workflow_dispatch:

jobs:
  update-files-inf:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Generate files.inf
        run: |
          # 添加文件头注释
          echo "# GitHub 云盘文件列表" > files.inf
          echo "# 自动生成，请勿手动编辑" >> files.inf
          echo "# 格式: 相对路径|显示名称|类型|大小|更新时间" >> files.inf
          echo "" >> files.inf
          
          # 遍历 files 目录（如果存在）
          if [ -d "files" ]; then
            find files -type f -o -type d | sort | while read -r filepath; do
              # 获取相对路径
              relpath="$filepath"
              
              # 获取显示名称
              displayname=$(basename "$filepath")
              
              # 判断类型
              if [ -d "$filepath" ]; then
                type="dir"
                size="0"
              else
                type="file"
                size=$(stat -f%z "$filepath" 2>/dev/null || stat -c%s "$filepath" 2>/dev/null || echo "0")
              fi
              
              # 获取更新时间
              updated=$(stat -f%Sm -t "%Y-%m-%dT%H:%M:%SZ" "$filepath" 2>/dev/null || stat -c%y "$filepath" 2>/dev/null | sed 's/ /T/' | sed 's/\.[0-9]*$/Z/' || date -u +"%Y-%m-%dT%H:%M:%SZ")
              
              # 写入文件
              echo "$relpath|$displayname|$type|$size|$updated" >> files.inf
            done
          fi
          
          echo "files.inf 已生成"
          cat files.inf
      
      - name: Commit and push changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          if git diff --quiet && git diff --staged --quiet; then
            echo "没有更改，无需提交"
          else
            git add files.inf
            git commit -m "chore: 自动更新 files.inf 文件列表"
            git push
          fi
name: Update index.html

on:
  push:
    branches: [ main, master ]
    paths:
      - 'files/**'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-files:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Generate index.html
        run: |
          cat > index.html << 'EOF'
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub ‰∫ëÁõò</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; border-radius: 8px; padding: 20px; }
        h1 { color: #333; margin-bottom: 20px; }
        .file-item { display: flex; align-items: center; padding: 12px; border-bottom: 1px solid #eee; }
        .file-icon { font-size: 24px; margin-right: 12px; }
        .file-name { flex: 1; }
        .file-size { color: #888; font-size: 0.9em; }
        .btn { padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; color: white; text-decoration: none; }
        .btn-download { background: #1976d2; }
        .empty { text-align: center; color: #888; padding: 40px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>‚òÅÔ∏è GitHub ‰∫ëÁõò</h1>
        <div class="file-list">
EOF
          
          if [ -d "files" ]; then
            find files -type d | sort | while read dirpath; do
              dirname=$(basename "$dirpath")
              if [ "$dirpath" != "files" ]; then
                echo '<div class="file-item">' >> index.html
                echo '<span class="file-icon">üìÅ</span>' >> index.html
                echo "<span class=\"file-name\">$dirname/</span>" >> index.html
                echo '</div>' >> index.html
              fi
            done
            
            find files -type f | sort | while read filepath; do
              filename=$(basename "$filepath")
              relpath=$(echo "$filepath" | sed 's|^files/||')
              size=$(stat -c%s "$filepath" 2>/dev/null || echo "0")
              
              if [ "$size" -lt 1024 ]; then
                size_disp="${size} B"
              elif [ "$size" -lt 1048576 ]; then
                size_disp="$((size / 1024)) KB"
              else
                size_disp="$((size / 1048576)) MB"
              fi
              
              url="https://raw.githubusercontent.com/wzmwayne/github_webdrive/main/files/$relpath"
              
              echo '<div class="file-item">' >> index.html
              echo '<span class="file-icon">üìÑ</span>' >> index.html
              echo "<span class=\"file-name\">$filename</span>" >> index.html
              echo "<span class=\"file-size\">$size_disp</span>" >> index.html
              echo "<a href=\"$url\" class=\"btn btn-download\" target=\"_blank\">‰∏ãËΩΩ</a>" >> index.html
              echo '</div>' >> index.html
            done
          else
            echo '<div class="empty">üì≠ ÊöÇÊó†Êñá‰ª∂</div>' >> index.html
          fi
          
          cat >> index.html << 'EOF'
        </div>
        <div style="margin-top: 30px; color: #888; text-align: center;">
            Powered by GitHub
        </div>
    </div>
</body>
</html>
EOF
          
          echo "Generated index.html"
          cat index.html
      
      - name: Commit and push
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          if ! git diff --quiet && ! git diff --staged --quiet; then
            git add index.html
            git commit -m "chore: update index.html"
            git push
          else
            echo "No changes"
          fi